<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Szauna Monitor - Smart Ticks</title>
    
    <script src="https://code.highcharts.com/stock/highstock.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body { background: #f4f7f6; height: 100vh; display: flex; flex-direction: column; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .header-controls { padding: 10px 15px; background: #fff; border-bottom: 1px solid #ddd; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .stats-bar { padding: 8px 20px; background: #fff; border-bottom: 1px solid #eee; font-weight: bold; font-size: 0.9rem; display: flex; flex-wrap: wrap; gap: 20px; }
        .temp-text { color: #d32f2f; }
        .grad-text { color: #800000; }
        #container { flex-grow: 1; width: 100%; }
        .btn-icon { width: 38px; }
    </style>
</head>
<body>

<div class="header-controls">
    <input type="date" id="datePicker" class="form-control form-control-sm w-auto">
    <button onclick="loadData()" class="btn btn-primary btn-sm px-3">OK</button>
    <button onclick="resetView()" class="btn btn-outline-secondary btn-sm btn-icon" title="Alaphelyzet">
        <i class="fas fa-home"></i>
    </button>
    <button onclick="loadData()" class="btn btn-outline-success btn-sm btn-icon" title="Frissítés">
        <i class="fas fa-sync-alt"></i>
    </button>
</div>

<div class="stats-bar">
    <div class="temp-text">HŐMÉRSÉKLET [°C]: Akt: <span id="t-akt">-</span> | Min: <span id="t-min">-</span> | Max: <span id="t-max">-</span></div>
    <div class="grad-text">GRADIENS [°C/perc]: Akt: <span id="g-akt">-</span> | Min: <span id="g-min">-</span> | Max: <span id="g-max">-</span></div>
</div>

<div id="container"></div>

<script>
const API_KEY = 'CM6CKHX2JG7IY375';
const CHAN_ID = '3213557';
let chart;

// Alapértelmezett dátum a mai nap
document.getElementById('datePicker').valueAsDate = new Date();

async function loadData() {
    const selectedDate = document.getElementById('datePicker').value;
    const startD = new Date(selectedDate + "T00:00:00");
    const endD = new Date(startD.getTime() + 24 * 60 * 60 * 1000);

    // +/- 3 óra lekérése a korrekciók miatt
    const qStart = new Date(startD.getTime() - 3 * 60 * 60 * 1000).toISOString();
    const qEnd = new Date(endD.getTime() + 3 * 60 * 60 * 1000).toISOString();

    const url = `https://api.thingspeak.com/channels/${CHAN_ID}/fields/1.json?api_key=${API_KEY}&start=${qStart}&end=${qEnd}`;

    try {
        const response = await fetch(url);
        const json = await response.json();
        const data = processFeeds(json.feeds, startD, endD);
        renderChart(data, startD, endD);
    } catch (e) {
        console.error("Adatlekérési hiba:", e);
    }
}

function processFeeds(feeds, dayStart, dayEnd) {
    let mainSeries = [];
    let stats = { t: [], g: [] };

    feeds.forEach((f) => {
        const time = new Date(f.created_at).getTime();
        const val = parseFloat(f.field1);
        if (isNaN(val)) return;

        // Gradiens (5 perces mozgóátlag alapú változás)
        let grad = 0;
        const prev = feeds.find(p => {
            const pt = new Date(p.created_at).getTime();
            return pt >= (time - 300000) && pt < time;
        });
        if (prev) {
            const dt = (time - new Date(prev.created_at).getTime()) / 60000;
            grad = (val - parseFloat(prev.field1)) / dt;
        }

        mainSeries.push({ x: time, y: val, grad: grad });

        if (time >= dayStart.getTime() && time <= dayEnd.getTime()) {
            stats.t.push(val);
            stats.g.push(grad);
        }
    });

    if (stats.t.length > 0) {
        document.getElementById('t-akt').innerText = stats.t[stats.t.length - 1].toFixed(1);
        document.getElementById('t-min').innerText = Math.min(...stats.t).toFixed(1);
        document.getElementById('t-max').innerText = Math.max(...stats.t).toFixed(1);
        document.getElementById('g-akt').innerText = stats.g[stats.g.length - 1].toFixed(2);
        document.getElementById('g-min').innerText = Math.min(...stats.g).toFixed(2);
        document.getElementById('g-max').innerText = Math.max(...stats.g).toFixed(2);
    }
    return mainSeries;
}

function renderChart(data, dayStart, dayEnd) {
    const todayData = data.filter(d => d.x >= dayStart.getTime() && d.x <= dayEnd.getTime());
    const maxVal = todayData.length ? Math.max(...todayData.map(d => d.y)) : 0;
    
    // Fix 0-100, de ha túllépi, 10-esével bővül
    const yAxisMax = maxVal > 100 ? Math.ceil(maxVal / 10) * 10 : 100;

    chart = Highcharts.stockChart('container', {
        chart: { spacingTop: 20 },
        time: { useUTC: false },
        rangeSelector: { enabled: false },
        scrollbar: { enabled: false }, // Tisztább kinézet, a Navigator elég
        navigator: {
            enabled: true,
            height: 60,
            series: { color: '#d32f2f', fillOpacity: 0.1 },
            xAxis: {
                labels: { enabled: false }
            }
        },
        xAxis: {
            type: 'datetime',
            min: dayStart.getTime(),
            max: dayEnd.getTime(),
            crosshair: {
                width: 1,
                color: '#555',
                dashStyle: 'Dash'
            },
            // KEREK IDŐPONTOK KÉNYSZERÍTÉSE
            units: [
                ['minute', [15, 30]], 
                ['hour', [1, 2, 4, 6]]
            ],
            title: { text: 'Időpont', style: { fontWeight: 'bold' } },
            events: {
                afterSetExtremes: function(e) {
                    // 15 perc zoom limit (900,000 ms)
                    if (e.max - e.min < 900000) {
                        this.setExtremes(e.min, e.min + 900000, true, false);
                    }
                }
            }
        },
        yAxis: {
            min: 0,
            max: yAxisMax,
            tickInterval: 10,
            opposite: false,
            title: { text: 'Hőmérséklet [°C]', style: { fontWeight: 'bold' } },
            gridLineColor: '#e6e6e6'
        },
        tooltip: {
            split: false,
            shared: true,
            useHTML: true,
            backgroundColor: 'rgba(255, 255, 255, 0.9)',
            formatter: function() {
                const p = this.points[0].point;
                return `<b>${Highcharts.dateFormat('%H:%M:%S', p.x)}</b><br/>
                        Hőmérséklet: <span style="color:red">${p.y.toFixed(1)} °C</span><br/>
                        Gradiens: <span style="color:brown">${p.grad.toFixed(2)} °C/p</span>`;
            }
        },
        series: [{
            name: 'Szauna',
            data: data,
            type: 'areaspline',
            color: '#d32f2f',
            fillColor: {
                linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1 },
                stops: [
                    [0, 'rgba(211, 47, 47, 0.5)'],
                    [1, 'rgba(211, 47, 47, 0)']
                ]
            },
            lineWidth: 2,
            states: { hover: { lineWidth: 3 } },
            threshold: null
        }]
    });
}

function resetView() {
    if (!chart) return;
    const selectedDate = document.getElementById('datePicker').value;
    const start = new Date(selectedDate + "T00:00:00").getTime();
    const end = new Date(selectedDate + "T23:59:59").getTime();
    chart.xAxis[0].setExtremes(start, end);
}

// Indítás
loadData();
</script>
</body>
</html>
