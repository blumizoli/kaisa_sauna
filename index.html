<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Szauna Hőmérséklet Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; background: #f4f4f4; }
        .controls { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        #chart-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: relative; height: 70vh; }
        input[type="date"] { padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 8px 15px; cursor: pointer; border: none; border-radius: 4px; background: #2196F3; color: white; font-weight: bold; }
        button:hover { background: #1976D2; }
        button:disabled { background: #ccc; }
        #loading-indicator { display: none; margin-left: 10px; font-size: 0.9em; color: #666; }
        .btn-reset { background: #607D8B; }
        .btn-update { background: #4CAF50; }
    </style>
</head>
<body>

    <div class="controls">
        <input type="date" id="datePicker">
        <button onclick="loadData()">OK</button>
        <button class="btn-reset" onclick="resetZoom()">ALAPNÉZET</button>
        <button class="btn-update" id="btnRefresh" onclick="refreshData()">FRISSÍTÉS</button>
        <span id="loading-indicator">Betöltés...</span>
    </div>

    <div id="chart-container">
        <canvas id="saunaChart"></canvas>
    </div>

<script>
    const API_KEY = 'CM6CKHX2JG7IY375';
    const CHAN_ID = '3213557';
    let myChart;

    // Alapértelmezett dátum ma
    document.getElementById('datePicker').valueAsDate = new Date();

    function initChart() {
        const ctx = document.getElementById('saunaChart').getContext('2d');
        
        myChart = new Chart(ctx, {
            type: 'line',
            data: { datasets: [{
                label: 'Hőmérséklet',
                borderColor: '#e74c3c',
                borderWidth: 2,
                data: [],
                stepped: false, // Sharp stílus
                pointRadius: 0,
                fill: false,
                tension: 0 // Nulla lekerekítés (sharp)
            }]},
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: { padding: { top: 10 } },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'hour',
                            displayFormats: { hour: 'HH:00', minute: 'HH:mm' }
                        },
                        min: getStartOfDay(),
                        max: getEndOfDay(),
                        title: { display: true, text: 'Idő' }
                    },
                    y: {
                        min: 0,
                        suggestedMax: 100,
                        title: { display: true, text: 'Hőmérséklet [°C]' },
                        ticks: { stepSize: 10 }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        enabled: true,
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(255, 255, 255, 0.8)',
                        titleColor: '#000',
                        bodyColor: '#000',
                        borderColor: '#ccc',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                const val = context.parsed.y.toFixed(1);
                                const grad = context.raw.gradient || 0;
                                return [`Hő: ${val} °C`, `Gradiens: ${grad.toFixed(2)} °C/perc`];
                            }
                        }
                    },
                    zoom: {
                        zoom: {
                            wheel: { enabled: true },
                            pinch: { enabled: true },
                            mode: 'x',
                            onZoomComplete: ({chart}) => {
                                // Minimum zoom limit: 15 perc (900000 ms)
                                const range = chart.scales.x.max - chart.scales.x.min;
                                if (range < 900000) {
                                    chart.resetZoom();
                                }
                            }
                        },
                        pan: { enabled: true, mode: 'x' }
                    }
                },
                interaction: { mode: 'index', intersect: false }
            }
        });
    }

    function getStartOfDay() {
        const d = new Date(document.getElementById('datePicker').value);
        d.setHours(0,0,0,0);
        return d.getTime();
    }

    function getEndOfDay() {
        const d = new Date(document.getElementById('datePicker').value);
        d.setHours(23,59,59,999);
        return d.getTime();
    }

    async function loadData(keepView = false) {
        const loader = document.getElementById('loading-indicator');
        loader.style.display = 'inline';
        
        const selectedDate = document.getElementById('datePicker').value;
        const start = new Date(selectedDate);
        start.setHours(-3, 0, 0); // -3 óra
        const end = new Date(selectedDate);
        end.setHours(27, 0, 0); // +3 óra (másnap 03:00)

        const url = `https://api.thingspeak.com/channels/${CHAN_ID}/feeds.json?api_key=${API_KEY}&start=${start.toISOString()}&end=${end.toISOString()}`;

        try {
            const response = await fetch(url);
            const data = await response.json();
            
            // Adatfeldolgozás
            let processedData = data.feeds.map(f => ({
                x: new Date(f.created_at).getTime(), // ThingSpeak ISO-t alapból UTC-nek veszi, JS Date helyi időre konvertálja
                y: parseFloat(f.field1)
            })).filter(p => !isNaN(p.y));

            // Gradiens számítás (5 perces mozgóátlag alapú változás)
            processedData = processedData.map((point, index, array) => {
                const fiveMinsAgo = point.x - (5 * 60 * 1000);
                const oldPoint = array.find(p => p.x >= fiveMinsAgo);
                let gradient = 0;
                if (oldPoint && oldPoint !== point) {
                    const timeDiffMin = (point.x - oldPoint.x) / 60000;
                    gradient = (point.y - oldPoint.y) / timeDiffMin;
                }
                return { ...point, gradient: gradient };
            });

            // Csak az adott napi adatok megjelenítése (00:00 - 23:59)
            const dayStart = getStartOfDay();
            const dayEnd = getEndOfDay();
            const finalData = processedData.filter(p => p.x >= dayStart && p.x <= dayEnd);

            myChart.data.datasets[0].data = finalData;

            if (!keepView) {
                myChart.options.scales.x.min = dayStart;
                myChart.options.scales.x.max = dayEnd;
                // Y tengely automatikus skálázás ha 100 fölé megy
                const maxVal = Math.max(...finalData.map(d => d.y), 100);
                myChart.options.scales.y.max = Math.ceil(maxVal / 10) * 10;
                myChart.resetZoom();
            }

            myChart.update('none');
        } catch (error) {
            console.error("Hiba az adatok letöltésekor:", error);
        } finally {
            loader.style.display = 'none';
        }
    }

    function resetZoom() {
        myChart.resetZoom();
        loadData(false);
    }

    function refreshData() {
        loadData(true);
    }

    // Inicializálás
    window.onload = () => {
        initChart();
        loadData();
    };
</script>
</body>
</html>
