<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kaisa Sauna Monitor Pro</title>
    <script src="https://code.highcharts.com/stock/highstock.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; box-sizing: border-box; }
        html, body { height: 100%; margin: 0; padding: 0; background: #f4f4f7; display: flex; flex-direction: column; padding: 5px; overflow: hidden; }
        .toolbar { display: flex; align-items: center; gap: 5px; background: white; padding: 8px; border-radius: 10px; margin-bottom: 5px; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .toolbar input { padding: 5px; border: 1px solid #ddd; border-radius: 5px; width: 130px; }
        .toolbar button { padding: 8px; border: 1px solid #eee; border-radius: 5px; background: white; cursor: pointer; min-width: 35px; }
        .stats-bar { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 5px; flex-shrink: 0; }
        .card { background: white; padding: 10px; border-radius: 10px; flex: 1; min-width: 140px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card-title { font-size: 10px; font-weight: bold; color: #777; text-transform: uppercase; margin-bottom: 5px; display: block; }
        .val-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; }
        .v-label { font-size: 8px; color: #999; text-transform: uppercase; }
        .v-data { font-size: 13px; font-weight: bold; }
        .status-badge { padding: 10px; border-radius: 5px; color: white; text-align: center; font-weight: bold; font-size: 11px; width: 100%; display: block; }
        #container { flex-grow: 1; background: white; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .spinning { animation: fa-spin 1s infinite linear; color: red !important; }
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; }
        .modal-c { background: white; padding: 20px; border-radius: 15px; width: 90%; max-width: 400px; }
    </style>
</head>
<body>

    <div class="toolbar">
        <input type="date" id="datePicker">
        <button id="zoomNowBtn"><i class="fas fa-search-plus"></i></button>
        <button id="homeBtn"><i class="fas fa-search-minus"></i></button>
        <button id="refreshBtn"><i id="refreshIcon" class="fas fa-sync-alt"></i></button>
        <button onclick="document.getElementById('modal').style.display='flex'"><i class="fas fa-question-circle"></i></button>
        <span id="lastUpdate" style="font-size: 9px; margin-left: auto; color: #999;">Frissítve: --</span>
    </div>

    <div class="stats-bar">
        <div class="card">
            <span class="card-title"><i class="fas fa-thermometer-half"></i> Hőmérséklet</span>
            <div class="val-grid">
                <div><div class="v-label">ÉLŐ</div><div class="v-data" id="t_akt" style="color:red">--</div><div id="t_time" style="font-size:7px; color:#999"></div></div>
                <div><div class="v-label">MIN</div><div class="v-data" id="t_min">--</div></div>
                <div><div class="v-label">MAX</div><div class="v-data" id="t_max">--</div></div>
            </div>
        </div>
        <div class="card">
            <span class="card-title"><i class="fas fa-chart-line"></i> Változás</span>
            <div class="val-grid">
                <div><div class="v-label">ÉLŐ</div><div class="v-data" id="g_akt" style="color:brown">--</div></div>
                <div><div class="v-label">MIN</div><div class="v-data" id="g_min">--</div></div>
                <div><div class="v-label">MAX</div><div class="v-data" id="g_max">--</div></div>
            </div>
        </div>
        <div class="card" style="min-width: 180px;">
            <span class="card-title">Állapot & ETA</span>
            <div style="display:flex; gap: 5px; align-items:center;">
                <div id="status" class="status-badge" style="background:#888">BETÖLTÉS...</div>
                <div id="eta_box" style="display:none; text-align:right; min-width:60px">
                    <div style="font-size:7px; color:#999">ETA 60°C</div>
                    <div id="eta_val" style="font-size:12px; font-weight:bold; color:red">--</div>
                </div>
            </div>
        </div>
    </div>

    <div id="container"></div>

    <div id="modal" onclick="this.style.display='none'">
        <div class="modal-c" onclick="event.stopPropagation()">
            <h3>Információ</h3>
            <p>ÜZEMI: >60°C<br>FELFŰTÉS: >0.75 °C/p<br>LASSULÓ: 0.1 - 0.75 °C/p</p>
            <button onclick="document.getElementById('modal').style.display='none'" style="width:100%; padding:10px;">Bezárás</button>
        </div>
    </div>

<script>
    const API_KEY = '4A8ZJFC1F0997T6A';
    const CHAN_ID = '3213557';
    let chart;

    const COLORS = { üzemi: "#800000", felfűtési: "#d32f2f", lassuló: "#ff8c00", stagnáló: "#888888", lehűlési: "#1976d2", készenléti: "#000000" };

    function getStatusType(t, g) {
        if (t >= 60) return "üzemi";
        if (t < 20) return "készenléti";
        if (g >= 0.75) return "felfűtési";
        if (g >= 0.1) return "lassuló";
        if (g >= -0.1) return "stagnáló";
        return "lehűlési";
    }

    async function fetchData() {
        const icon = document.getElementById('refreshIcon');
        icon.classList.add('spinning');
        
        const selDate = document.getElementById('datePicker').value;
        const start = selDate + "T00:00:00Z";
        const end = selDate + "T23:59:59Z";

        try {
            // 1. ÉLŐ ADATOK (Utolsó 15 perc)
            const liveR = await fetch(`https://api.thingspeak.com/channels/${CHAN_ID}/feeds.json?api_key=${API_KEY}&minutes=15`);
            const liveD = await liveR.json();
            
            if (liveD.feeds && liveD.feeds.length > 0) {
                const last = liveD.feeds[liveD.feeds.length - 1];
                const t_now = parseFloat(last.field1);
                
                let prev = liveD.feeds[0];
                const lastMs = new Date(last.created_at).getTime();
                for(let i=liveD.feeds.length-1; i>=0; i--) {
                    if ((lastMs - new Date(liveD.feeds[i].created_at).getTime()) > 300000) { prev = liveD.feeds[i]; break; }
                }
                const dt = (lastMs - new Date(prev.created_at).getTime())/60000;
                const g_now = dt > 0 ? (t_now - parseFloat(prev.field1))/dt : 0;
                const st = getStatusType(t_now, g_now);

                document.getElementById('t_akt').innerText = t_now.toFixed(1);
                document.getElementById('t_time').innerText = new Date(last.created_at).toLocaleTimeString();
                document.getElementById('g_akt').innerText = (g_now > 0 ? "+":"") + g_now.toFixed(2);
                const sB = document.getElementById('status');
                sB.innerText = st.toUpperCase();
                sB.style.background = COLORS[st];

                const eB = document.getElementById('eta_box');
                if ((st === "felfűtési" || st === "lassuló") && t_now < 60 && g_now > 0.05) {
                    const mins = Math.round((60 - t_now) / g_now);
                    document.getElementById('eta_val').innerText = mins + "p";
                    eB.style.display = "block";
                } else { eB.style.display = "none"; }
            }

            // 2. GRAFIKON ADATOK
            const archR = await fetch(`https://api.thingspeak.com/channels/${CHAN_ID}/feeds.json?api_key=${API_KEY}&start=${start}&end=${end}`);
            const archD = await archR.json();
            
            let points = [], temps = [], grads = [];
            if (archD.feeds) {
                archD.feeds.forEach((f, i) => {
                    const t = parseFloat(f.field1);
                    const ts = new Date(f.created_at).getTime();
                    let g = 0;
                    if (i > 0) {
                        const dt = (ts - new Date(archD.feeds[i-1].created_at).getTime())/60000;
                        g = dt > 0 ? (t - parseFloat(archD.feeds[i-1].field1))/dt : 0;
                    }
                    points.push({x: ts, y: t, g: g, st: getStatusType(t, g)});
                    temps.push(t); grads.push(g);
                });
            }

            chart.series[0].setData(points);
            if (temps.length > 0) {
                document.getElementById('t_min').innerText = Math.min(...temps).toFixed(1);
                document.getElementById('t_max').innerText = Math.max(...temps).toFixed(1);
                document.getElementById('g_min').innerText = Math.min(...grads).toFixed(2);
                document.getElementById('g_max').innerText = Math.max(...grads).toFixed(2);
                
                const minAx = Math.min(0, Math.floor(Math.min(...temps)/10)*10);
                const maxAx = Math.max(90, Math.ceil(Math.max(...temps)/10)*10);
                chart.yAxis[0].setExtremes(minAx, maxAx);
            }

        } catch (err) { console.error(err); }
        
        icon.classList.remove('spinning');
        document.getElementById('lastUpdate').innerText = "Frissítve: " + new Date().toLocaleTimeString();
    }

    // Inicializálás
    document.getElementById('datePicker').value = new Date().toISOString().split('T')[0];
    
    chart = Highcharts.stockChart('container', {
        rangeSelector: { enabled: false }, scrollbar: { enabled: false }, credits: { enabled: false },
        xAxis: { type: 'datetime', ordinal: false },
        yAxis: { min: 0, max: 90, tickInterval: 10, opposite: false },
        tooltip: {
            split: false, shared: true, useHTML: true,
            formatter: function() {
                const p = this.points[0].point;
                return `<b>${Highcharts.dateFormat('%H:%M:%S', this.x)}</b><br>Hőfok: ${p.y.toFixed(1)}°C<br>Gradiens: ${p.g.toFixed(2)}<br>Státusz: ${p.st}`;
            }
        },
        series: [{ name: 'Szauna', data: [], type: 'area', color: '#d32f2f', lineWidth: 2, fillColor: { linearGradient: {x1:0,y1:0,x2:0,y2:1}, stops: [[0,'rgba(211,47,47,0.3)'],[1,'rgba(211,47,47,0)']] } }]
    });

    document.getElementById('refreshBtn').onclick = () => fetchData();
    document.getElementById('datePicker').onchange = () => fetchData();
    document.getElementById('homeBtn').onclick = () => {
        const d = document.getElementById('datePicker').value;
        chart.xAxis[0].setExtremes(new Date(d+"T00:00:00").getTime(), new Date(d+"T23:59:59").getTime());
    };
    document.getElementById('zoomNowBtn').onclick = () => {
        const now = Date.now();
        chart.xAxis[0].setExtremes(now - 3600000, now + 600000);
    };

    fetchData();
    setInterval(fetchData, 60000);
</script>
</body>
</html>
